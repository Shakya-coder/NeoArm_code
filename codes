#!/usr/bin/env python3
import time
import threading
import subprocess
import pigpio
import RPi.GPIO as GPIO

import data  # sensor module

import board
import busio
from adafruit_ssd1306 import SSD1306_I2C
from PIL import Image, ImageDraw, ImageFont


REAL = True

# ============================================================
# GPIO DEFINITIONS
# ============================================================

PIN_THUMB = 22
PIN_IM = 18
PIN_RP = 17

PIN_WRIST = 23
PIN_ELBOW = 24

PIN_PUSH = 27        # push button → GND

MAX_ANGLE = 180
STEP = 3
STEP_DELAY = 0.015

GRIP_THRESHOLD = 150   # mA current stop


# ============================================================
# pigpio initialization FIRST
# ============================================================
pi = pigpio.pi()
if not pi.connected:
    print("[ERR] pigpio failed to start")
else:
    print("[MAIN] pigpio connected.")


# ============================================================
# OLED INIT
# ============================================================

i2c = busio.I2C(board.SCL, board.SDA)
oled = SSD1306_I2C(128, 64, i2c)

oled.fill(0)
oled.show()

font = ImageFont.load_default()


def update_oled():
    """OLED feedback display"""
    try:
        temp = data.get_temperature()
        pressure = data.get_palm_pressure()
        bv, bp = data.get_battery_level()
    except:
        temp, pressure, bv, bp = 0, 0, 0, 0

    img = Image.new("1", (128, 64))
    draw = ImageDraw.Draw(img)

    draw.text((0, 0), "NeoArm Status", font=font, fill=255)
    draw.text((0, 16), f"Temp: {temp:.1f} C", font=font, fill=255)
    draw.text((0, 28), f"Palm: {pressure:.1f}%", font=font, fill=255)
    draw.text((0, 40), f"Batt: {bp:.0f}% ({bv:.2f}V)", font=font, fill=255)

    oled.image(img)
    oled.show()


def oled_loop():
    while True:
        update_oled()
        time.sleep(0.5)


threading.Thread(target=oled_loop, daemon=True).start()


# ============================================================
# SERVO CONTROL
# ============================================================

def servo_write(pin, angle):
    pulse = 500 + (angle / 180.0) * 2000
    pi.set_servo_pulsewidth(pin, pulse)


def servo_off(pin):
    pi.set_servo_pulsewidth(pin, 0)


def get_avg_current():
    vals = []
    for _ in range(3):
        try:
            vals.append(data.get_finger_current())
        except:
            vals.append(0)
        time.sleep(0.008)
    return sum(vals) / len(vals)


def close_until_grip(pin):
    """Stop early when object detected via current spike"""
    print(f"[SERVO] Closing pin {pin}")

    for ang in range(0, MAX_ANGLE + 1, STEP):
        servo_write(pin, ang)
        time.sleep(STEP_DELAY)

        curr = get_avg_current()
        print(f"[CURR] {curr} mA")

        if curr >= GRIP_THRESHOLD:
            print(f"[GRIP] Stopped at {ang}°, current={curr}")
            return True

    print(f"[SERVO] Fully closed pin {pin}")
    return False


def open_finger(pin):
    print(f"[SERVO] Opening pin {pin}")
    for ang in range(MAX_ANGLE, -1, -STEP):
        servo_write(pin, ang)
        time.sleep(STEP_DELAY)


# ============================================================
# GROUP CONTROL
# ============================================================

def all_close():
    print("[ACTION] Closing ALL fingers")
    close_until_grip(PIN_THUMB)
    close_until_grip(PIN_IM)
    close_until_grip(PIN_RP)


def all_open():
    print("[ACTION] Opening ALL fingers")
    open_finger(PIN_THUMB)
    open_finger(PIN_IM)
    open_finger(PIN_RP)


# Used by wireless mode
def thumb_on(): close_until_grip(PIN_THUMB)
def thumb_off(): open_finger(PIN_THUMB)

def im_on(): close_until_grip(PIN_IM)
def im_off(): open_finger(PIN_IM)

def rp_on(): close_until_grip(PIN_RP)
def rp_off(): open_finger(PIN_RP)

def all_on(): all_close()
def all_off(): all_open()


# ============================================================
# MODE MANAGEMENT
# ============================================================

current_mode = "button"
push_state = False


def set_mode(m):
    global current_mode
    current_mode = m
    print(f"[MODE] Changed to: {m}")


# ============================================================
# PUSH BUTTON — pigpio interrupt
# ============================================================

def handle_push(gpio):
    global push_state

    if current_mode != "button":
        print("[BTN] Ignored (not in button mode)")
        return

    print("[BTN] Button pressed")

    if not push_state:
        print("[BTN] Closing fingers")
        all_close()
        push_state = True
    else:
        print("[BTN] Opening fingers")
        all_open()
        push_state = False


# configure pin
pi.set_mode(PIN_PUSH, pigpio.INPUT)
pi.set_pull_up_down(PIN_PUSH, pigpio.PUD_UP)

# register callback
btn_cb = pi.callback(PIN_PUSH, pigpio.FALLING_EDGE, handle_push)
print("[MAIN] Push button interrupt OK (pigpio)")


# ============================================================
# WRIST + ELBOW THREAD
# ============================================================

def joint_loop():
    while True:
        wp = data.get_wrist_angle()
        ep = data.get_elbow_angle()

        print(f"[JOINT] Wrist={wp}%, Elbow={ep}%")

        servo_write(PIN_WRIST, int((wp / 100) * 180))
        servo_write(PIN_ELBOW, int((ep / 100) * 180))

        time.sleep(0.05)


threading.Thread(target=joint_loop, daemon=True).start()


# ============================================================
# FSR THREAD
# ============================================================

def fsr_loop():
    while True:
        if current_mode == "fsr":
            if data.get_trigger_fsr():
                print("[FSR] GRIP detected → closing")
                all_close()
            else:
                print("[FSR] Released → opening")
                all_open()
        time.sleep(0.05)


threading.Thread(target=fsr_loop, daemon=True).start()


# ============================================================
# MAIN LOOP
# ============================================================

if __name__ == "__main__":
    print("[MAIN] NeoArm started")
    set_mode(current_mode)

    print("[MAIN] Launching webserver…")
    subprocess.Popen(["python3", "/home/rohit/NeoArm/webserver.py"])

    try:
        while True:
            time.sleep(1)

    except KeyboardInterrupt:
        print("[MAIN] Shutting down…")
        servo_off(PIN_THUMB)
        servo_off(PIN_IM)
        servo_off(PIN_RP)
        servo_off(PIN_WRIST)
        servo_off(PIN_ELBOW)
        pi.stop()
        print("[MAIN] Clean exit.")
