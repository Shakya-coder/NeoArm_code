#!/usr/bin/env python3
import time
import pigpio
import RPi.GPIO as GPIO
from adafruit_ina219 import INA219
import board
import busio

# ============================
# HARDWARE CONFIG
# ============================

PIN_SERVO = 22        # Servo test pin
PIN_BUTTON = 27       # Push button to GND
INA_ADDR = 0x40       # INA219 current sensor

MAX_ANGLE = 180
STEP = 4
STEP_DELAY = 0.010
GRIP_THRESHOLD = 1500   # mA stop threshold

# ============================
# INIT GPIO
# ============================

GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)
GPIO.setup(PIN_BUTTON, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# ============================
# INIT pigpio
# ============================

pi = pigpio.pi()
if not pi.connected:
    print("ERROR: pigpio is not running")
    quit()

# ============================
# INIT INA219
# ============================

i2c = busio.I2C(board.SCL, board.SDA)
ina = INA219(i2c, addr=INA_ADDR)

# ============================
# SERVO FUNCTIONS
# ============================

def servo_write(angle):
    pulse = 500 + (angle / 180.0) * 2000
    pi.set_servo_pulsewidth(PIN_SERVO, pulse)

def servo_off():
    pi.set_servo_pulsewidth(PIN_SERVO, 0)

# ============================
# READ CURRENT (3 sample avg)
# ============================

def get_avg_current():
    values = []
    for _ in range(3):
        try:
            values.append(ina.current)
        except:
            values.append(0)
        time.sleep(0.005)
    return sum(values) / len(values)

# ============================
# CLOSE UNTIL GRIP
# ============================

def close_until_grip():
    print("ACTION: Closing servo...")
    for ang in range(0, MAX_ANGLE + 1, STEP):
        servo_write(ang)
        time.sleep(STEP_DELAY)

        curr = get_avg_current()
        print("Angle =", ang, "Current =", curr, "mA")

        if curr >= GRIP_THRESHOLD:
            print("GRIP DETECTED at angle", ang, "current", curr)
            return

    print("Reached full close. No grip detected.")

# ============================
# OPEN
# ============================

def open_servo():
    print("ACTION: Opening servo...")
    for ang in range(MAX_ANGLE, -1, -STEP):
        servo_write(ang)
        time.sleep(STEP_DELAY)
    print("Servo fully open")

# ============================
# MAIN
# ============================

print("--------------------------------------------")
print("Test: Servo + INA219 grip detection")
print("Servo pin: GPIO 22")
print("INA219 address: 0x40")
print("Push button: GPIO 27 to GND")
print("Press button to toggle OPEN/CLOSE")
print("--------------------------------------------")

state = False  # False = open, True = closed

try:
    while True:
        if GPIO.input(PIN_BUTTON) == 0:
            time.sleep(0.05)
            if GPIO.input(PIN_BUTTON) == 0:
                print("BUTTON PRESSED")

                if not state:
                    close_until_grip()
                    state = True
                else:
                    open_servo()
                    state = False

                while GPIO.input(PIN_BUTTON) == 0:
                    time.sleep(0.05)

        time.sleep(0.01)

except KeyboardInterrupt:
    print("Exiting test...")
    servo_off()
    GPIO.cleanup()
    pi.stop()

