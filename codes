#!/usr/bin/env python3
# webserver.py
# Simple, clean webserver for NeoArm (UI like your screenshot).

import json
from http.server import BaseHTTPRequestHandler, HTTPServer
from urllib.parse import unquote
import time

# Try to import hardware/data. If missing, simulate.
try:
    import data
    import hardware
    REAL = True
    print("[WEB] hardware + data modules imported (REAL mode).")
except Exception as e:
    data = None
    hardware = None
    REAL = False
    print("[WEB] Running in SIMULATION MODE:", e)

# internal state
current_mode = "button"
button_states = {"thumb": False, "im": False, "rp": False, "all": False}

def set_all_fingers(state: bool):
    button_states["all"] = state
    button_states["thumb"] = state
    button_states["im"] = state
    button_states["rp"] = state

def simulated_feedback():
    t = int(time.time()) % 60
    return {
        "pressure": (t % 10) * 10,
        "temperature": 25 + (t % 5),
        "battery_percent": 80,
        "battery_voltage": 11.7
    }

# HTML — simplified and responsive, styled to look like your screenshot
HTML = """<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NeoArm Webapplication</title>
<style>
:root{--bg:#f6f7fa;--card:#fff;--muted:#9aa0a6;--accent:#2ecc71;--shadow:0 8px 16px rgba(18,18,18,0.06)}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
.topbar{background:var(--card);padding:18px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow)}
.title{font-weight:700;font-size:20px}
.status{display:flex;align-items:center;gap:8px;color:#222}
.dot{width:12px;height:12px;border-radius:999px;background:#00c853;display:inline-block}
.container{padding:14px;max-width:820px;margin:0 auto}
.section{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);margin-bottom:14px}
.h2{font-size:16px;margin:0 0 12px 0;font-weight:700}
.mode-row{display:flex;gap:10px;align-items:center}
.mode-btn{background:#fff;border:1px solid #e6e6e6;padding:10px 16px;border-radius:10px;cursor:pointer;color:#111}
.mode-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.control-row{display:flex;flex-direction:column;gap:12px}
.control-item{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:10px;padding:14px;border:1px solid #f0f0f0}
.control-label{font-size:16px;font-weight:600}
.control-btn{padding:10px 18px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;font-weight:700}
.control-btn.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.control-btn.disabled{background:#f3f3f3;color:#999;cursor:default;border-color:#eee}
.feedback-cards{display:flex;flex-direction:column;gap:12px}
.card-box{background:#0f1114;color:#fff;padding:22px;border-radius:12px}
.card-title{font-size:18px;font-weight:700;text-align:center;margin-bottom:12px}
.card-value{font-size:20px;text-align:center;color:#1de9b6}
.footer-note{font-size:12px;color:var(--muted);text-align:center;padding:8px}
@media(min-width:720px){ .feedback-cards{flex-direction:row;gap:12px} .card-box{flex:1} }
</style>
</head>
<body>
<div class="topbar">
  <div class="title">NeoArm Webapplication<br><span style="font-size:12px;color:var(--muted);font-weight:400">Control & feedback panel</span></div>
  <div class="status"><span class="dot" id="online_dot"></span><span id="online_text">Online</span></div>
</div>

<div class="container">
  <div class="section">
    <div class="h2">Mode selection</div>
    <div class="mode-row">
      <button id="m_fsr" class="mode-btn" onclick="setMode('fsr')">EMG</button>
      <button id="m_push" class="mode-btn" onclick="setMode('button')">Push Button</button>
      <button id="m_wire" class="mode-btn" onclick="setMode('wire')">Wireless</button>
    </div>
  </div>

  <div class="section">
    <div class="h2">Control panel</div>
    <div class="control-row">
      <div class="control-item"><div class="control-label">Thumb</div><button id="btn_thumb" class="control-btn" onclick="toggle('thumb')">OFF</button></div>
      <div class="control-item"><div class="control-label">Index + Middle</div><button id="btn_im" class="control-btn" onclick="toggle('im')">OFF</button></div>
      <div class="control-item"><div class="control-label">Ring + Pinky</div><button id="btn_rp" class="control-btn" onclick="toggle('rp')">OFF</button></div>
      <div class="control-item"><div class="control-label">All Fingers</div><button id="btn_all" class="control-btn" onclick="toggle('all')">OFF</button></div>
    </div>
  </div>

  <div class="section">
    <div class="h2">NeoArm Feedback</div>
    <div class="feedback-cards">
      <div class="card-box"><div class="card-title">Pressure</div><div class="card-value" id="fb_pressure">--%</div><div style="text-align:center;color:#bdbdbd;margin-top:8px">Palm pressure</div></div>
      <div class="card-box"><div class="card-title">Temperature</div><div class="card-value" id="fb_temp">-- °C</div><div style="text-align:center;color:#bdbdbd;margin-top:8px">LM35 temperature</div></div>
      <div class="card-box"><div class="card-title">Battery Status</div><div class="card-value" id="fb_batt_pct">--%</div><div style="text-align:center;color:#bdbdbd;margin-top:8px" id="fb_batt_v">-- V</div></div>
    </div>
  </div>

  <div class="footer-note">Tap a control to toggle. The UI auto-syncs every 1s.</div>
</div>

<script>
let mode = "button";
let buttonState = {thumb:false, im:false, rp:false, all:false};

function api_get(path){ return fetch(path, {cache:"no-store"}).then(r => r); }

function setMode(m){
  mode = m;
  api_get('/mode/' + encodeURIComponent(m)).then(_ => refreshUI()).catch(_ => refreshUI());
}

function toggle(name){
  if(mode !== 'wire') return;
  const el = document.getElementById('btn_' + name);
  const isOn = el.classList.contains('on');
  const action = isOn ? 'off' : 'on';
  api_get('/' + name + '/' + action)
    .then(r => r.json()).then(data => updateButtonsFromState(data)).catch(_ => { el.classList.toggle('on'); el.innerText = el.classList.contains('on') ? 'ON' : 'OFF'; });
}

function updateButtonsFromState(state){
  ['thumb','im','rp','all'].forEach(k => {
    const el = document.getElementById('btn_' + k);
    if(state[k]){ el.classList.add('on'); el.innerText='ON'; } else { el.classList.remove('on'); el.innerText='OFF'; }
  });
}

function refreshUI(){
  api_get('/feedback').then(r => r.json()).then(d => {
    document.getElementById('fb_pressure').innerText = d.pressure + '%';
    document.getElementById('fb_temp').innerText = d.temperature + ' °C';
    document.getElementById('fb_batt_pct').innerText = d.battery_percent + '%';
    document.getElementById('fb_batt_v').innerText = d.battery_voltage + ' V';
    document.getElementById('online_dot').style.background = '#00c853';
    document.getElementById('online_text').innerText = 'Online';
  }).catch(_ => {
    document.getElementById('online_dot').style.background = '#999';
    document.getElementById('online_text').innerText = 'Offline';
  });

  api_get('/status').then(r => r.json()).then(s => {
    mode = s.mode || mode;
    document.getElementById('m_fsr').classList.toggle('active', mode === 'fsr');
    document.getElementById('m_push').classList.toggle('active', mode === 'button');
    document.getElementById('m_wire').classList.toggle('active', mode === 'wire');
    updateButtonsFromState(s.buttons || buttonState);
    const disabled = (mode !== 'wire');
    ['thumb','im','rp','all'].forEach(k => {
      const el = document.getElementById('btn_' + k);
      if(disabled){ el.classList.remove('on'); el.classList.add('disabled'); el.style.pointerEvents='none'; el.innerText = s.buttons && s.buttons[k] ? 'ON' : 'OFF'; }
      else { el.classList.remove('disabled'); el.style.pointerEvents='auto'; }
    });
  }).catch(_ => {});
}

setInterval(refreshUI, 1000);
window.addEventListener('load', refreshUI);
</script>

</body>
</html>
"""

# ------------------------
# HTTP handler
# ------------------------
class Handler(BaseHTTPRequestHandler):
    def _send_text(self, code, text):
        self.send_response(code)
        self.send_header("Content-type", "text/plain; charset=utf-8")
        self.end_headers()
        self.wfile.write(text.encode('utf-8'))

    def _send_json(self, code, obj):
        j = json.dumps(obj)
        self.send_response(code)
        self.send_header("Content-type", "application/json; charset=utf-8")
        self.end_headers()
        self.wfile.write(j.encode('utf-8'))

    def do_GET(self):
        global current_mode, button_states

        path = unquote(self.path)
        if path == "/" or path.startswith("/index"):
            self.send_response(200)
            self.send_header("Content-type", "text/html; charset=utf-8")
            self.end_headers()
            self.wfile.write(HTML.encode('utf-8'))
            return

        # mode change
        if path.startswith("/mode/"):
            m = path.split("/mode/")[1].lower()
            if m in ("fsr","button","wire"):
                current_mode = "fsr" if m=="fsr" else ("wire" if m=="wire" else "button")
                # inform main/hardware if possible
                try:
                    if REAL and hasattr(hardware, "set_mode"):
                        hardware.set_mode(current_mode)
                except:
                    pass
                print("[WEB] Mode set to:", current_mode)
                self._send_text(200, "OK")
                return
            else:
                self._send_text(400, "Invalid mode")
                return

        # toggle endpoints: /thumb/on etc.
        parts = path.strip("/").split("/")
        if len(parts) == 2 and parts[0] in ("thumb","im","rp","all") and parts[1] in ("on","off"):
            name = parts[0]; action = parts[1]
            new_state = (action == "on")
            if name == "all":
                set_all_fingers(new_state)
            else:
                button_states[name] = new_state
                if name in ("thumb","im","rp") and not new_state:
                    button_states["all"] = False
                if name in ("thumb","im","rp") and new_state:
                    if button_states["thumb"] and button_states["im"] and button_states["rp"]:
                        button_states["all"] = True

            # call hardware functions if available
            if REAL:
                try:
                    func_name = f"{name}_{'on' if new_state else 'off'}"
                    if hasattr(hardware, func_name):
                        getattr(hardware, func_name)()
                    else:
                        # fallback: call all_on/all_off for 'all'
                        if name == "all":
                            if new_state: hardware.all_on()
                            else: hardware.all_off()
                except Exception as e:
                    print("[WEB] hardware call error:", e)

            self._send_json(200, button_states.copy())
            return

        # feedback
        if path == "/feedback":
            if REAL:
                try:
                    fb = data.get_all_feedback()
                    resp = {
                        "pressure": fb.get("palm_pressure"),
                        "temperature": fb.get("temperature"),
                        "battery_percent": fb.get("battery_percent"),
                        "battery_voltage": fb.get("battery_voltage")
                    }
                except Exception as e:
                    resp = simulated_feedback()
            else:
                resp = simulated_feedback()
            self._send_json(200, resp)
            return

        # status
        if path == "/status":
            if REAL:
                try:
                    fb = data.get_all_feedback()
                except:
                    fb = simulated_feedback()
            else:
                fb = simulated_feedback()

            out = {"mode": current_mode, "buttons": button_states.copy(), "feedback": fb}
            self._send_json(200, out)
            return

        self.send_error(404, "Not found: " + path)
        return

# ------------------------
# Start server
# ------------------------
def run():
    addr = ("0.0.0.0", 8080)
    server = HTTPServer(addr, Handler)
    print(f"[WEB] NeoArm webserver running on http://{addr[0]}:{addr[1]}")
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print("\n[WEB] Shutting down.")
        server.server_close()

if __name__ == "__main__":
    run()
