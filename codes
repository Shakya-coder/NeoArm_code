#!/usr/bin/env python3
import time
import threading
import pigpio
import subprocess
import RPi.GPIO as GPIO

import data      # sensor functions (ADS1115 + INA219)

REAL = True

# ===========================================================
# GPIO / SERVO PINS
# ===========================================================
PIN_THUMB = 22
PIN_IM    = 18
PIN_RP    = 17

PIN_WRIST = 23
PIN_ELBOW = 24

PIN_PUSH  = 27     # push button

# ===========================================================
# SERVO CONTROL PARAMETERS
# ===========================================================
MAX_ANGLE = 180
STEP = 6             # servo speed (increase for faster)
STEP_DELAY = 0.008   # small delay

GRIP_THRESHOLD_FINGER = 150   # mA (INA219 @ 0x40)
GRIP_THRESHOLD_THUMB  = 150   # mA (INA219 @ 0x41)

# ===========================================================
# GPIO SETUP (NO LED, NO BUZZER)
# ===========================================================
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

GPIO.setup(PIN_PUSH, GPIO.IN, pull_up_down=GPIO.PUD_UP)
try:
    GPIO.remove_event_detect(PIN_PUSH)
except:
    pass

# ===========================================================
# CONNECT pigpio
# ===========================================================
pi = pigpio.pi()
if not pi.connected:
    print("[ERR] pigpio NOT connected!")
else:
    print("[MAIN] pigpio connected.")

# ===========================================================
# SERVO WRITE
# ===========================================================
def servo_write(pin, angle):
    pw = 500 + (angle / 180.0) * 2000
    pi.set_servo_pulsewidth(pin, pw)

def servo_off(pin):
    pi.set_servo_pulsewidth(pin, 0)

# ===========================================================
# GET AVERAGED CURRENT
# ===========================================================
def get_avg_current_finger():
    vals = []
    for _ in range(3):
        try:
            vals.append(data.get_finger_current())
        except:
            vals.append(0)
        time.sleep(0.004)
    avg = sum(vals) / len(vals)
    print(f"[CURRENT-FINGER] {avg} mA")
    return avg

def get_avg_current_thumb():
    vals = []
    for _ in range(3):
        try:
            vals.append(data.get_thumb_current())
        except:
            vals.append(0)
        time.sleep(0.004)
    avg = sum(vals) / len(vals)
    print(f"[CURRENT-THUMB] {avg} mA")
    return avg

# ===========================================================
# CLOSE WITH CURRENT LOGIC
# ===========================================================
def close_until_grip(pin, is_thumb=False):
    print(f"[SERVO] Closing pin {pin}")

    for ang in range(0, MAX_ANGLE+1, STEP):
        servo_write(pin, ang)
        time.sleep(STEP_DELAY)

        curr = get_avg_current_thumb() if is_thumb else get_avg_current_finger()

        if curr >= (GRIP_THRESHOLD_THUMB if is_thumb else GRIP_THRESHOLD_FINGER):
            print(f"[GRIP] STOP @ angle {ang}, current={curr} mA")
            return True

    print("[GRIP] FULL CLOSED")
    return False


def open_finger(pin):
    print(f"[SERVO] Opening pin {pin}")
    for ang in range(MAX_ANGLE, -1, -STEP):
        servo_write(pin, ang)
        time.sleep(STEP_DELAY)
    print("[SERVO] Fully opened")

# ===========================================================
# GROUP CONTROLS
# ===========================================================
def all_close():
    print("[ACTION] ALL FINGERS CLOSE")
    close_until_grip(PIN_THUMB, is_thumb=True)
    close_until_grip(PIN_IM)
    close_until_grip(PIN_RP)

def all_open():
    print("[ACTION] ALL FINGERS OPEN")
    open_finger(PIN_THUMB)
    open_finger(PIN_IM)
    open_finger(PIN_RP)

# Individual wireless controls
def thumb_on(): close_until_grip(PIN_THUMB, is_thumb=True)
def thumb_off(): open_finger(PIN_THUMB)

def im_on(): close_until_grip(PIN_IM)
def im_off(): open_finger(PIN_IM)

def rp_on(): close_until_grip(PIN_RP)
def rp_off(): open_finger(PIN_RP)

def all_on(): all_close()
def all_off(): all_open()

# ===========================================================
# MODE MANAGEMENT
# ===========================================================
current_mode = "button"
push_state = False

def set_mode(m):
    global current_mode
    current_mode = m
    print(f"[MODE] Changed to: {m}")

# ===========================================================
# PUSH BUTTON HANDLER
# ===========================================================
def _handle_push(channel):
    global push_state

    if current_mode != "button":
        print("[BTN] Ignored - Not in button mode")
        return

    print("[BTN] Press detected")

    if not push_state:
        all_close()
        push_state = True
    else:
        all_open()
        push_state = False

try:
    GPIO.add_event_detect(PIN_PUSH, GPIO.FALLING,
                          callback=_handle_push, bouncetime=250)
    print("[MAIN] Push button interrupt enabled")
except Exception as e:
    print("[ERR] Failed to set interrupt:", e)

# ===========================================================
# WRIST + ELBOW LOOP
# ===========================================================
def joint_loop():
    while True:
        wp = data.get_wrist_angle()
        ep = data.get_elbow_angle()

        servo_write(PIN_WRIST, int((wp/100)*180))
        servo_write(PIN_ELBOW, int((ep/100)*180))

        print(f"[JOINT] Wrist={wp}%, Elbow={ep}%")
        time.sleep(0.05)

threading.Thread(target=joint_loop, daemon=True).start()

# ===========================================================
# FSR LOOP
# ===========================================================
def fsr_loop():
    while True:
        if current_mode == "fsr":
            trig = data.get_trigger_fsr()
            print("[FSR] Trigger =", trig)

            if trig:
                all_close()
            else:
                all_open()

        time.sleep(0.05)

threading.Thread(target=fsr_loop, daemon=True).start()

# ===========================================================
# MAIN ENTRY
# ===========================================================
if __name__ == "__main__":
    print("[MAIN] NeoArm started")
    set_mode(current_mode)

    print("[MAIN] Launching webserverâ€¦")
    subprocess.Popen(["python3", "/home/rohit/NeoArm/webserver.py"])

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("[MAIN] Shutdown")
        servo_off(PIN_THUMB)
        servo_off(PIN_IM)
        servo_off(PIN_RP)
        servo_off(PIN_WRIST)
        servo_off(PIN_ELBOW)
        GPIO.cleanup()
        pi.stop()
