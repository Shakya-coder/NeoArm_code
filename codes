#!/usr/bin/env python3
"""
hardware.py  -- servo + grip logic (uses pigpio instance attached by main.py)
Do NOT create a pigpio instance here. main.py will call attach_pigpio(pi).
"""

import time
import data  # uses INA219 + ADS1115

# pins for fingers (BCM)
PIN_THUMB = 22
PIN_IM = 18
PIN_RP = 17

MAX_ANGLE = 180
STEP = 3
STEP_DELAY = 0.012  # faster sweep
GRIP_THRESHOLD = 150  # mA threshold (tweak as needed)

# pigpio instance will be attached by main.py
pi = None

def attach_pigpio(pi_instance):
    """Attach the pigpio instance created by main.py"""
    global pi
    pi = pi_instance
    if pi is None:
        print("[HARDWARE] pigpio not attached (pi is None)")
    else:
        print("[HARDWARE] pigpio attached")

def set_mode(m):
    """Optional hook - webserver/main call this to log mode in hardware"""
    print(f"[HARDWARE] Mode set to: {m}")

def _write_servo_pulse(pin, angle):
    """Write servo pulse if pi attached"""
    if pi is None:
        print(f"[HARDWARE] Warning: pigpio not attached. Cannot move servo {pin}")
        return
    pulse = 500 + (angle / 180.0) * 2000
    pi.set_servo_pulsewidth(pin, int(pulse))

def servo_off(pin):
    if pi is not None:
        pi.set_servo_pulsewidth(pin, 0)

def get_avg_current():
    vals = []
    for _ in range(3):
        try:
            vals.append(data.get_finger_current())
        except Exception:
            vals.append(0)
        time.sleep(0.006)
    return sum(vals) / len(vals)

def close_until_grip(pin):
    """Close a single finger until current spike (returns True if stopped early)"""
    print(f"[GRIP] Closing servo {pin}")
    for ang in range(0, MAX_ANGLE + 1, STEP):
        _write_servo_pulse(pin, ang)
        time.sleep(STEP_DELAY)
        curr = get_avg_current()
        print(f"[GRIP] pin={pin} angle={ang} current={curr}")
        if curr >= GRIP_THRESHOLD:
            print(f"[GRIP] pin={pin} STOP at angle={ang} (current {curr} mA)")
            return True
    print(f"[GRIP] pin={pin} fully closed")
    return False

def open_finger(pin):
    print(f"[OPEN] Opening servo {pin}")
    for ang in range(MAX_ANGLE, -1, -STEP):
        _write_servo_pulse(pin, ang)
        time.sleep(STEP_DELAY)
    # leave servo powered at 0 angle (optionally turn off)
    # servo_off(pin)

# group operations
def all_close():
    close_until_grip(PIN_THUMB)
    close_until_grip(PIN_IM)
    close_until_grip(PIN_RP)

def all_open():
    open_finger(PIN_THUMB)
    open_finger(PIN_IM)
    open_finger(PIN_RP)

# individual controls for webserver UI calls
def thumb_on(): close_until_grip(PIN_THUMB)
def thumb_off(): open_finger(PIN_THUMB)

def im_on(): close_until_grip(PIN_IM)
def im_off(): open_finger(PIN_IM)

def rp_on(): close_until_grip(PIN_RP)
def rp_off(): open_finger(PIN_RP)

def all_on(): all_close()
def all_off(): all_open()

def shutdown():
    """Turn off servos cleanly"""
    print("[HARDWARE] shutdown: turning off servos")
    try:
        servo_off(PIN_THUMB)
        servo_off(PIN_IM)
        servo_off(PIN_RP)
    except Exception as e:
        print("[HARDWARE] shutdown error:", e)
