#!/usr/bin/env python3
# CLEAN & STABLE WEB SERVER FOR NEOARM

import json
from http.server import BaseHTTPRequestHandler, HTTPServer
from urllib.parse import unquote
import time

# --------------------------------------------
# IMPORT HARDWARE MODULE
# --------------------------------------------
try:
    import hardware      # <-- The real control functions
    import data
    REAL = True
    print("[WEB] Hardware + Data modules loaded")
except Exception as e:
    REAL = False
    print("[WEB] Running in SIMULATION MODE:", e)


# --------------------------------------------
# INTERNAL STATE
# --------------------------------------------
current_mode = "button"

button_states = {
    "thumb": False,
    "im": False,
    "rp": False,
    "all": False
}

def set_all_fingers(state: bool):
    button_states["all"] = state
    button_states["thumb"] = state
    button_states["im"] = state
    button_states["rp"] = state


# --------------------------------------------
# SIMULATION FEEDBACK IF HARDWARE MISSING
# --------------------------------------------
def simulated_feedback():
    t = time.time() % 60
    return {
        "pressure": int((t % 10) * 10),
        "temperature": 25 + int((t % 5)),
        "battery_percent": 80,
        "battery_voltage": 11.7
    }


# --------------------------------------------
# THE WEBPAGE (NO UTF ERRORS)
# --------------------------------------------
HTML = """
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>NeoArm Control Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#f2f3f7; font-family:Arial; }
.container { padding:15px; max-width:800px; margin:auto; }
.card { background:#fff; padding:15px; border-radius:10px; margin-bottom:12px; box-shadow:0 4px 10px rgba(0,0,0,0.06);}
.btn { padding:10px 18px; border-radius:8px; border:1px solid #888; cursor:pointer; }
.btn.on { background:#2ecc71; color:#fff; border-color:#27ae60; }
.mode-btn { padding:10px 14px; margin-right:8px; border-radius:8px; cursor:pointer; border:1px solid #777;}
.mode-btn.active { background:#2ecc71; color:white; }
</style>
</head>
<body>

<div class="container">

<h2>Mode Selection</h2>
<div class="card">
<button class="mode-btn" onclick="setMode('fsr')" id="m_fsr">EMG</button>
<button class="mode-btn" onclick="setMode('button')" id="m_button">Push Button</button>
<button class="mode-btn" onclick="setMode('wire')" id="m_wire">Wireless</button>
</div>

<h2>Finger Control</h2>
<div class="card">
<button id="btn_thumb" class="btn" onclick="toggle('thumb')">Thumb</button>
<button id="btn_im" class="btn" onclick="toggle('im')">Index+Middle</button>
<button id="btn_rp" class="btn" onclick="toggle('rp')">Ring+Pinky</button>
<button id="btn_all" class="btn" onclick="toggle('all')">All</button>
</div>

<h2>Feedback</h2>
<div class="card">
<p>Pressure: <span id="fb_p">--</span>%</p>
<p>Temperature: <span id="fb_t">--</span>C</p>
<p>Battery: <span id="fb_bp">--</span>% (<span id="fb_bv">--</span>V)</p>
</div>

</div>

<script>

function api(path){
    return fetch(path, {cache:"no-store"}).then(r => r.json());
}

function setMode(m){
    api("/mode/" + m);
}

function toggle(name){
    api("/toggle/" + name);
}

setInterval(() => {
    api("/status").then(d => {
        document.getElementById("fb_p").innerText = d.feedback.pressure;
        document.getElementById("fb_t").innerText = d.feedback.temperature;
        document.getElementById("fb_bp").innerText = d.feedback.battery_percent;
        document.getElementById("fb_bv").innerText = d.feedback.battery_voltage;

        let mode = d.mode;
        document.getElementById("m_fsr").classList.toggle("active", mode==="fsr");
        document.getElementById("m_button").classList.toggle("active", mode==="button");
        document.getElementById("m_wire").classList.toggle("active", mode==="wire");

        ["thumb","im","rp","all"].forEach(n => {
            let el = document.getElementById("btn_" + n);
            el.classList.toggle("on", d.buttons[n]);
        });
    });
}, 1000);

</script>

</body>
</html>
"""


# --------------------------------------------
# REQUEST HANDLER
# --------------------------------------------
class Handler(BaseHTTPRequestHandler):

    def _json(self, code, obj):
        self.send_response(code)
        self.send_header("Content-Type", "application/json")
        self.end_headers()
        self.wfile.write(json.dumps(obj).encode())

    def _html(self):
        self.send_response(200)
        self.send_header("Content-Type", "text/html")
        self.end_headers()
        self.wfile.write(HTML.encode())

    def do_GET(self):
        global current_mode, button_states

        path = unquote(self.path)

        # ROOT PAGE
        if path == "/" or path == "/index":
            return self._html()

        # MODE CHANGE
        if path.startswith("/mode/"):
            mode = path.split("/mode/")[1]
            current_mode = mode
            print(f"[WEB] Mode changed → {mode}")

            if REAL:
                try:
                    hardware.set_mode(mode)
                except:
                    pass

            return self._json(200, {"mode": mode})

        # FINGER TOGGLE
        if path.startswith("/toggle/"):
            name = path.split("/toggle/")[1]
            if name not in button_states:
                return self._json(400, {"error": "Invalid finger"})

            new_state = not button_states[name]
            button_states[name] = new_state

            print(f"[WEB] Finger {name} → {new_state}")

            if REAL:
                try:
                    if name == "all":
                        hardware.all_close() if new_state else hardware.all_open()
                    else:
                        func = getattr(hardware, f"{name}_{'on' if new_state else 'off'}")
                        func()
                except Exception as e:
                    print("[WEB] ERROR calling hardware:", e)

            return self._json(200, button_states)

        # STATUS (UI refresh)
        if path == "/status":
            if REAL:
                fb = data.get_all_feedback()
            else:
                fb = simulated_feedback()

            return self._json(200, {
                "mode": current_mode,
                "buttons": button_states,
                "feedback": fb
            })

        self.send_error(404)


# --------------------------------------------
# START SERVER
# --------------------------------------------
def run():
    addr = ("0.0.0.0", 8080)
    print("[WEB] Listening on http://0.0.0.0:8080")
    HTTPServer(addr, Handler).serve_forever()


if __name__ == "__main__":
    run()
