# hardware.py
# Servo + grip control. Uses data.get_* for INA219 readings and pigpio for servos.

import time
import threading

# pigpio instance will be attached from main.py
pi = None

# servo pins (BCM)
PIN_THUMB = 22
PIN_IM = 18
PIN_RP = 17

# servo motion settings
MAX_ANGLE = 180
STEP = 4
STEP_DELAY = 0.010   # speed - smaller = faster

# threshold (mA)
GRIP_THRESHOLD = 150.0

# import data module lazily (main imports data anyway)
try:
    import data
except Exception:
    data = None

def attach_pigpio(p):
    global pi
    pi = p
    print("[HARDWARE] pigpio instance attached")

def _servo_write(pin, angle):
    """Write angle (0..180) -> pulsewidth (500..2500 us)."""
    if pi is None:
        return
    pulse = 500 + (angle / 180.0) * 2000
    try:
        pi.set_servo_pulsewidth(pin, int(pulse))
    except Exception as e:
        print("[HARDWARE] servo write error:", e)

def servo_off(pin):
    if pi is None:
        return
    try:
        pi.set_servo_pulsewidth(pin, 0)
    except Exception:
        pass

def _avg_thumb_current():
    # average 3 samples from data.get_thumb_current()
    vals = []
    for _ in range(3):
        try:
            vals.append(data.get_thumb_current())
        except Exception:
            vals.append(0.0)
        time.sleep(0.006)
    return sum(vals) / len(vals)

def _avg_finger_current():
    # average 3 samples from data.get_finger_current()
    vals = []
    for _ in range(3):
        try:
            vals.append(data.get_finger_current())
        except Exception:
            vals.append(0.0)
        time.sleep(0.006)
    return sum(vals) / len(vals)

# ---------- finger control ----------

def close_thumb_until_grip():
    """Close thumb servo until thumb INA crosses threshold."""
    print("[HARDWARE] Closing thumb until grip")
    for ang in range(0, MAX_ANGLE + 1, STEP):
        _servo_write(PIN_THUMB, ang)
        time.sleep(STEP_DELAY)
        curr = _avg_thumb_current()
        print(f"[HARDWARE] Thumb angle={ang} current={curr} mA")
        if curr >= GRIP_THRESHOLD:
            print("[HARDWARE] Thumb grip detected - stopping")
            return True
    print("[HARDWARE] Thumb fully closed (no spike)")
    return False

def open_thumb():
    print("[HARDWARE] Opening thumb")
    for ang in range(MAX_ANGLE, -1, -STEP):
        _servo_write(PIN_THUMB, ang)
        time.sleep(STEP_DELAY)
    print("[HARDWARE] Thumb opened")

def close_fingers_group_until_grip():
    """
    Close index+middle and ring+pinky together.
    Uses group INA (finger INA) to detect a spike and stop both.
    """
    print("[HARDWARE] Closing finger group until grip")
    for ang in range(0, MAX_ANGLE + 1, STEP):
        _servo_write(PIN_IM, ang)
        _servo_write(PIN_RP, ang)
        time.sleep(STEP_DELAY)
        curr = _avg_finger_current()
        print(f"[HARDWARE] Group angle={ang} current={curr} mA")
        if curr >= GRIP_THRESHOLD:
            print("[HARDWARE] Group grip detected - stopping both")
            return True
    print("[HARDWARE] Group fully closed (no spike)")
    return False

def open_fingers_group():
    print("[HARDWARE] Opening finger group")
    for ang in range(MAX_ANGLE, -1, -STEP):
        _servo_write(PIN_IM, ang)
        _servo_write(PIN_RP, ang)
        time.sleep(STEP_DELAY)
    print("[HARDWARE] Finger group opened")

# high-level helpers (called by main/webserver)
def thumb_on():
    close_thumb_until_grip()

def thumb_off():
    open_thumb()

def im_on():
    close_fingers_group_until_grip()

def im_off():
    open_fingers_group()

def rp_on():
    # same as im (group), keep for API compatibility
    close_fingers_group_until_grip()

def rp_off():
    open_fingers_group()

def all_on():
    # Close thumb, then close group. They will stop on spikes.
    close_thumb_until_grip()
    close_fingers_group_until_grip()

def all_off():
    open_thumb()
    open_fingers_group()

# utility shutdown
def shutdown():
    try:
        servo_off(PIN_THUMB)
        servo_off(PIN_IM)
        servo_off(PIN_RP)
    except Exception:
        pass
    print("[HARDWARE] shutdown complete")
