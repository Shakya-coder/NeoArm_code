import time
import Adafruit_ADS1x15
import RPi.GPIO as GPIO

# Initialize ADS1115
adc = Adafruit_ADS1x15.ADS1115()
GAIN = 1

# Servo setup
servo_pin = 18  # GPIO pin connected to servo
GPIO.setmode(GPIO.BCM)
GPIO.setup(servo_pin, GPIO.OUT)
pwm = GPIO.PWM(servo_pin, 50)  # 50Hz frequency
pwm.start(0)

def set_servo_angle(angle):
    duty = 2 + (angle / 18)
    pwm.ChangeDutyCycle(duty)
    time.sleep(0.02)
    pwm.ChangeDutyCycle(0)

try:
    print("Starting potentiometer-servo test...")
    while True:
        try:
            value = adc.read_adc(0, gain=GAIN)  # Read from A0
            angle = int((value / 32767) * 180)  # Map 0–32767 to 0–180°
            angle = max(0, min(180, angle))
            print(f"Pot value: {value}, Servo angle: {angle}")
            set_servo_angle(angle)
            time.sleep(0.1)
        except Exception as e:
            print(f"[Warning] Read error: {str(e)}")
            time.sleep(0.2)

except KeyboardInterrupt:
    print("\nStopped by user")

finally:
    pwm.stop()
    GPIO.cleanup()
    print("Clean exit")
