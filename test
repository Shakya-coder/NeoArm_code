import time
import pigpio
import Adafruit_ADS1x15

# Initialize pigpio and ADC
pi = pigpio.pi()
adc = Adafruit_ADS1x15.ADS1115()
GAIN = 1

# Servo settings
SERVO_PIN = 18
SERVO_MIN = 600    # 0 degrees
SERVO_MAX = 2400   # 180 degrees

# Functions
def set_servo_angle(angle):
    pulse = SERVO_MIN + (angle / 180.0) * (SERVO_MAX - SERVO_MIN)
    pi.set_servo_pulsewidth(SERVO_PIN, pulse)

def sweep_servo(current, target, step=1, delay=0.01):
    if current == target:
        return current
    if current < target:
        for angle in range(current, target + 1, step):
            set_servo_angle(angle)
            time.sleep(delay)
    else:
        for angle in range(current, target - 1, -step):
            set_servo_angle(angle)
            time.sleep(delay)
    return target

def read_pot(channel=0, samples=5):
    values = [adc.read_adc(channel, gain=GAIN) for _ in range(samples)]
    return sum(values) / len(values)

# Main
current_angle = 90
set_servo_angle(current_angle)

try:
    while True:
        pot_value = read_pot()
        target_angle = int((pot_value / 32767.0) * 180)
        target_angle = max(0, min(180, target_angle))
        current_angle = sweep_servo(current_angle, target_angle, step=1, delay=0.01)
        print(f"Pot: {pot_value:.0f} → Servo: {current_angle}°")

except KeyboardInterrupt:
    pass

finally:
    pi.set_servo_pulsewidth(SERVO_PIN, 0)
    pi.stop()
