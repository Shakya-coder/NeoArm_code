import time
import pigpio
import Adafruit_ADS1x15

# Initialize pigpio and ADC
pi = pigpio.pi()
adc = Adafruit_ADS1x15.ADS1115()
GAIN = 1

# Servo pin (BCM numbering)
SERVO_PIN = 18

# Servo pulse range (microseconds)
SERVO_MIN = 500     # 0 degrees
SERVO_MAX = 2500    # 180 degrees

def set_servo_angle(angle):
    pulse = SERVO_MIN + (angle / 180) * (SERVO_MAX - SERVO_MIN)
    pi.set_servo_pulsewidth(SERVO_PIN, pulse)

try:
    print("Starting smooth potentiometer-servo test...")
    while True:
        try:
            pot_value = adc.read_adc(0, gain=GAIN)  # Read from channel A0
            angle = int((pot_value / 32767) * 180)  # Map ADC 0–32767 → 0–180°
            angle = max(0, min(180, angle))
            print(f"Pot: {pot_value} → Servo: {angle}°")
            set_servo_angle(angle)
            time.sleep(0.05)
        except Exception as e:
            print(f"[Warning] ADC read error: {e}")
            time.sleep(0.1)

except KeyboardInterrupt:
    print("\nStopped by user.")

finally:
    pi.set_servo_pulsewidth(SERVO_PIN, 0)
    pi.stop()
    print("Clean exit.")
